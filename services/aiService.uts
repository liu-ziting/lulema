export type AiAnalysisResult = {
	content: string
	success: boolean
}

export const analyzeCheckIns = (records: any[]): Promise<AiAnalysisResult> => {
	return new Promise((resolve, reject) => {
		// æ•´ç†æ•°æ®Prompt
		let promptData = "æˆ‘æœ€è¿‘çš„æ‰“å¡è®°å½•å¦‚ä¸‹ï¼š\n";
		// å–æœ€è¿‘20æ¡ï¼Œé¿å…tokenè¿‡é•¿
		const recentRecords = records.slice(-20);
		
		recentRecords.forEach((item, index) => {
			const date = new Date(item['timestamp'] as number);
			const dateStr = `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ ${date.getHours()}:${date.getMinutes()}`;
			const reason = item['reason'] || "æœªè®°å½•åŽŸå› ";
			promptData += `${index + 1}. æ—¶é—´ï¼š${dateStr}ï¼ŒåŽŸå› ï¼š${reason}\n`;
		});

		promptData += `
è¯·æ‰®æ¼”ä¸€ä½æ—¢å¹½é»˜åˆçŠ€åˆ©çš„â€œæˆ’è‰²æŸå‹â€å…¼â€œé‡‘ç‰Œæ•™ç»ƒâ€ã€‚è¯·æ ¹æ®æˆ‘çš„è®°å½•ï¼Œç”¨â€œä½ æ€»æ˜¯åœ¨...ç„¶åŽ...æœ€åŽ...â€çš„å™è¿°é£Žæ ¼æ¥åˆ†æžæˆ‘çš„è¡Œä¸ºæ¨¡å¼ã€‚
å…·ä½“è¦æ±‚ï¼š
1. ðŸ•µï¸ è§„å¾‹æ­ç§˜ï¼šç”¨â€œæˆ‘çœ‹å‡ºæ¥äº†ï¼Œä½ æ€»æ˜¯åœ¨...â€å¼€å¤´ï¼Œä¸€é’ˆè§è¡€ä¸”ç•¥å¸¦è°ƒä¾ƒåœ°æŒ‡å‡ºæˆ‘çš„é«˜é£Žé™©æ—¶é—´ç‚¹å’Œå€Ÿå£ï¼ˆæ¯”å¦‚â€œä½ æ€»æ˜¯åœ¨æ·±å¤œå¯‚å¯žéš¾è€çš„æ—¶å€™å·å·â€˜é¹¿â€™ï¼Œæ˜¯ä¸æ˜¯ä»¥ä¸ºè¢«çªé‡Œå°±æ˜¯æ³•å¤–ä¹‹åœ°ï¼Ÿâ€ï¼‰ã€‚
2. ðŸ“‰ å‰§æƒ…æŽ¨æ¼”ï¼šæŽ¥ç€ç”¨â€œç„¶åŽ...â€æè¿°æˆ‘äº‹åŽçš„çŠ¶æ€ï¼ˆæ¯”å¦‚â€œç„¶åŽé™·å…¥è´¤è€…æ—¶é—´çš„æ— å°½ç©ºè™šï¼Œçœ‹ç€å¤©èŠ±æ¿å‘èª“è¿™æ˜¯æœ€åŽä¸€æ¬¡ï¼Œç»“æžœä¸‹æ¬¡è¿˜æ•¢â€ï¼‰ã€‚
3. ðŸ’¡ æ¸©é¦¨æç¤ºï¼šæœ€åŽç»™å‡ºä¸€ä»½â€œæ¸©é¦¨æç¤ºâ€ï¼ŒåŒ…å«3ä¸ªæœ‰è¶£ä½†ç¡¬æ ¸çš„å»ºè®®ï¼Œè¯­æ°”è¦åƒè€æœ‹å‹ä¸€æ ·çœŸè¯šï¼ˆæ¯”å¦‚â€œæ¸©é¦¨æç¤ºï¼šä¸‹æ¬¡æ‰‹ç—’çš„æ—¶å€™ï¼Œä¸å¦‚åšä¸ªä¿¯å§æ’‘ï¼Œåˆ«è®©å«ç”Ÿçº¸æˆä¸ºä½ å”¯ä¸€çš„å¬ä¼—â€ï¼‰ã€‚
è¯·ç›´æŽ¥å¼€å§‹ä½ çš„è¡¨æ¼”ï¼Œä¸è¦æœ‰ä»»ä½•å¼€åœºç™½ã€‚`;

		uni.request({
			url: 'https://open.bigmodel.cn/api/paas/v4/chat/completions',
			method: 'POST',
			header: {
				'Content-Type': 'application/json',
				'Authorization': 'Bearer a835b9f6866d48ec956d341418df8a50.NuhlKYn58EkCb5iP'
			},
			data: {
				model: "glm-4-flash", // ä½¿ç”¨æ›´å¿«çš„Flashæ¨¡åž‹ï¼Œæˆ–è€…ç”¨æˆ·æŒ‡å®šçš„ GLM-4.1V-Thinking-Flash (ä½†é€šå¸¸APIè°ƒç”¨æ ‡å‡†åä¸º glm-4 ç³»åˆ—)
				messages: [
					{
						role: "user",
						content: promptData
					}
				],
				temperature: 0.7
			},
			success: (res) => {
				const data = res.data as any;
				if (data['choices'] != null) {
					const choices = data['choices'] as any[];
					if (choices.length > 0) {
						const content = choices[0]['message']['content'] as string;
						resolve({
							content: content,
							success: true
						} as AiAnalysisResult);
						return;
					}
				}
				resolve({
					content: "åˆ†æžå¤±è´¥ï¼Œè¯·ç¨åŽå†è¯•",
					success: false
				} as AiAnalysisResult);
			},
			fail: (err) => {
				console.error('AI Request Failed:', err);
				resolve({
					content: "ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ",
					success: false
				} as AiAnalysisResult);
			}
		});
	});
}
